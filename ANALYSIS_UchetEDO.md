# Анализ работы УчетЭДО

> \*Данный текст не является частью анализа и нужно удалить при сдаче.
> 
> Результатом анализа является ответ на вопрос:
> - Как интегрировать подписи системы, так чтобы они могли проверяться на check.doodocs.kz?
>

 - **Какой тип подписи? - XML, CMS, etc.**
	
		XML подпись

 - **Как выглядит подписанный документ, который подтверждает факт успешного подписания?**
		
		Это .zip архив, который называется всегда doument.zip, а файлы внутри называются как их UUID на сервисе.

  		Далее может быть 2 случая, если загружаете pdf и если загружаете другой формат.

		Если pdf:
			Архив содержит папку document, в которой находятся:
				Pdf файлы <названия>: 
				- Сведения о документе  <UUID_info.pdf>
				- Оригинал документа    <UUID.pdf>
				- Печатная форма        <UUID_print.pdf>
				- XML файл попдипсей    <UUID.xml>
- _Пример:_

	![PdfFiles](https://github.com/Tr8ch/AnalysisUchet/blob/main/images/filesUchetEdo.png)

		Если другой формат:
			Архив содержит 3 файла:
				- Оригинал документа    <UUID.(расширения файла: odt, docx...)>
				- Сведения о документе  <UUID_info.pdf>
				- XML файл подписей     <UUID.xml>
- _Пример:_

	![NonPdfFiles](https://github.com/Tr8ch/AnalysisUchet/blob/main/images/NonPdfFiles.png)
			
 - **Что конкретно подписывается? - Хеш, бинарные данные, UUID документ и т.д.**
		
		Ваш документ хэшируется алгоритмом md5 и полученный хэш подписывается NCAlayer-ом.

 - **Как проверяется на сервисе?**
 - **Как можно проверить подпись вне этого сервиса?**

	
## HTTP-запросы

### №1. Загрузка документа

	Загрузка документа на сервисе Учет ЭДО происходит на стороне фронта. Далее файл кодируется в base64 так же на фронте, после этого с помощью WebSocket-а подключается NCAlayer и уже непосредственно в NCAlayer отправляется строка файла хэшированная в md5 кодировке и возвращается подпись (xml строка).

### №2. Отправка подписи

	Подписывание происходит NCAlayer-ом. Сервис подключается к NCAlayer-у с помощью WebSocket-а 

	- И так чтобы подписать документ нам нужно создать подключение(connect) к webSocket-у
	- Можете попробывать через приложение webSocat или PostMan
	- В моем случае я воспользуюсь PostMan-ом
	- Итак заходим в PostMan меняем `request type` с `HTTP` на `WebSocket`
	- Вводим такой `URL`: wss://127.0.0.1:13579/ (P.S. у вас должен быть включен NCAlayer)
	- Во вкладке `Message` заполняем вот так:

  ```json
 {
	"module":"kz.gov.pki.knca.basics",
	"method":"sign",
	"args":
		{
			"allowedStorages":["PKCS12"],
			"format":"xml","data":"<root><md5-hash>..Content..</md5-hash></root>",
			"signingParams":
				{
					"decode":"false",
					"encapsulate":"true",
					"digested":"false",
					"tsaProfile":{}
				},
			"signerParams":
				{
					"extKeyUsageOids":[],
					"chain":[]
				},
			"locale":"ru"
		}
}
  ```
- `..Content..` - это хэш файла, который формируется на фронте (md5)

#### Ответ:

```json
{
    "body": {
        "result": [
            "xml подпись..."
        ]
    },
    "status": true
}
```

## Описание подписанного документа

> \*Данный текст не является частью анализа и нужно удалить при сдаче.
> 
> В этом разделе нужно описать результирующий подписанный файл. Целью данного раздела является разведка всей полезной информации выдаваемой в результирующем файле.
> 
> - Если это архив, то описать каждый файл с указанием названия и объяснением что содержится в этом файле.
> - Если это PDF, то описать каждую секцию с указанием названия секции и что в себе содержит.
> - Если в документах содержатся QR'ы, то отсканировать каждый и понять как его использовать при верификации подписи. Данный момент отразить в описании.
> - Если в документах содержатся URL ссылки, то зайти по ссылке, понять что она отображает и чем может быть полезна. Данный момент отразить в описании.
> 
> То же самое касается любой потенциально полезной информации.
>  
>  Можно прилагать скрины.

### При подписании PDF документа

#### Сведения о документе:  <UUID_info.pdf>

Сначала идут строковые данные:
- Название подписанного документа и сервиса с помощью которого документ был подписан (*Учет.ЭДО*)
- Хеш документа (*MD5*)
- Ссылки на электронный документ отправителя и получателя

![rawData.png](https://github.com/Tr8ch/AnalysisUchet/blob/main/images/rawData.png)

Таблица:
- Время подписания документа с двух сторон
- Информация про каждого контрагента:
	- ФИО
	- Email
	- Права
	- Информация о сертификате
	- Удостоверяющий центр
	- Кем выдан
	- Номер сертификата
	- Срок сертификата

![tableData.png](https://github.com/Tr8ch/AnalysisUchet/blob/main/images/tableData.png)

Подписи отправителя и получателя:

![signature.png](https://github.com/Tr8ch/AnalysisUchet/blob/main/images/signature.png)

## Описание подписей

> \*Данный текст не является частью анализа и нужно удалить при сдаче.
> 
> В этом разделе нужно проанализировать результирующие подписи. Целью этого раздела является анализ содержимого подписей, какая информация хранится в подписи, что конкретно подписывается и любая другая полезная информация.
>
> В данной секции обязательно описать что подписывается ЭЦП ключом - хеш, бинарные данные, UUID документ и т.д. Если это хеш, то как он формируется.
>  
>  В данной секции следует описать команды и инструменты используемые для анализа. Если это bash скрипты то написать команду, вывод и описание.
>   
>  Можно прилагать скрины.

## Описание процесса верификации подписей на сервисе

> \*Данный текст не является частью анализа и нужно удалить при сдаче.
> 
> В этом разделе нужно описать процессы того, как сервис предлагает проверить подпись на легитимность. Перечислить все доступные методы рекомендованные сервисом. Возможно данная информация будет храниться в статьях, блогах или FAQ сервиса.
>  
>  Можно прилагать скрины.

## Описание процесса верификации подписей вне сервиса

> \*Данный текст не является частью анализа и нужно удалить при сдаче.
> 
> В этом разделе нужно описать процессы того, как можно проверить подписи на легитимность вне сервиса, используя технические инструменты - kalkan, openssl и т.д.

---

> \*Данный текст не является частью анализа и нужно удалить при сдаче.
> 
> Если у вас есть дополнительные секции, которые вы хотели бы включить, то оформите ее согласно структуре во всем документе.
